"use client"

import { useEffect, useState } from "react"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogDescription,
  DialogFooter,
} from "@/components/ui/dialog"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table"
import { Badge } from "@/components/ui/badge"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog"
import {
  Package2,
  Plus,
  Search,
  TrendingDown,
  TrendingUp,
  Eye,
  Edit,
  Trash2,
  History,
} from "lucide-react"
import { toast } from "@/lib/toast"

// Interfaces sesuai dengan struktur database baru
interface Material {
  id: string
  code: string
  name: string
  description: string | null
  unit: string
  supplier: string | null
}

interface MaterialColorVariant {
  id: string
  materialId: string
  colorName: string
  colorCode: string | null
  stock: number
  minimumStock: number
  price: number
  rollQuantity: number | null
  meterPerRoll: number | null
  purchaseOrderNumber: string | null
  purchaseDate: string | null
  purchaseNotes: string | null
  supplier: string | null
  isActive: boolean
  material: Material
}

interface Statistics {
  totalVariants: number
  lowStockItems: number
  outOfStockItems: number
  totalValue: number
}

export default function StocksPage() {
  const [variants, setVariants] = useState<MaterialColorVariant[]>([])
  const [materials, setMaterials] = useState<Material[]>([])
  const [statistics, setStatistics] = useState<Statistics>({
    totalVariants: 0,
    lowStockItems: 0,
    outOfStockItems: 0,
    totalValue: 0,
  })
  const [isLoading, setIsLoading] = useState(true)
  const [searchQuery, setSearchQuery] = useState("")

  // Dialog states
  const [isCreateMaterialOpen, setIsCreateMaterialOpen] = useState(false)
  const [isAddVariantOpen, setIsAddVariantOpen] = useState(false)
  const [isEditVariantOpen, setIsEditVariantOpen] = useState(false)
  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false)
  const [selectedVariant, setSelectedVariant] = useState<MaterialColorVariant | null>(null)
  const [isSaving, setIsSaving] = useState(false)

  // Forms
  const [createMaterialForm, setCreateMaterialForm] = useState({
    code: "",
    name: "",
    description: "",
    unit: "METER",
    supplier: "",
  })

  const [variantForm, setVariantForm] = useState({
    materialId: "",
    colorName: "",
    colorCode: "",
    stock: 0,
    minimumStock: 0,
    price: 0,
    rollQuantity: 0,
    meterPerRoll: 0,
    purchaseOrderNumber: "",
    purchaseDate: "",
    purchaseNotes: "",
    supplier: "",
  })

  useEffect(() => {
    fetchData()
  }, [])

  const fetchData = async () => {
    try {
      setIsLoading(true)
      await Promise.all([fetchVariants(), fetchMaterials()])
    } catch (error) {
      console.error("Error fetching data:", error)
    } finally {
      setIsLoading(false)
    }
  }

  const fetchVariants = async () => {
    try {
      const response = await fetch("/api/material-color-variants")
      const data = await response.json()

      if (data.success) {
        setVariants(data.data)
        
        // Calculate statistics
        const totalValue = data.data.reduce(
          (sum: number, v: MaterialColorVariant) => sum + v.stock * v.price,
          0
        )
        const lowStock = data.data.filter(
          (v: MaterialColorVariant) => v.stock > 0 && v.stock <= v.minimumStock
        ).length
        const outOfStock = data.data.filter(
          (v: MaterialColorVariant) => v.stock === 0
        ).length

        setStatistics({
          totalVariants: data.data.length,
          lowStockItems: lowStock,
          outOfStockItems: outOfStock,
          totalValue,
        })
      }
    } catch (error) {
      console.error("Error fetching variants:", error)
    }
  }

  const fetchMaterials = async () => {
    try {
      const response = await fetch("/api/materials")
      const data = await response.json()

      if (data.success) {
        setMaterials(data.data)
      }
    } catch (error) {
      console.error("Error fetching materials:", error)
    }
  }

  const handleCreateMaterial = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsSaving(true)

    try {
      const response = await fetch("/api/materials", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          code: createMaterialForm.code.trim(),
          name: createMaterialForm.name.trim(),
          description: createMaterialForm.description.trim() || null,
          unit: "METER",
          supplier: createMaterialForm.supplier.trim() || null,
        }),
      })

      const data = await response.json()

      if (data.success) {
        await fetchMaterials()
        setIsCreateMaterialOpen(false)
        setCreateMaterialForm({
          code: "",
          name: "",
          description: "",
          unit: "METER",
          supplier: "",
        })
        toast.success("Bahan Baku Ditambahkan", `${createMaterialForm.name} berhasil ditambahkan`)
      } else {
        toast.error("Gagal Menambahkan", data.error || "Tidak dapat menambahkan bahan baku")
      }
    } catch (error) {
      console.error("Error creating material:", error)
      toast.error("Error", "Gagal menambahkan bahan baku")
    } finally {
      setIsSaving(false)
    }
  }

  const handleAddVariant = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsSaving(true)

    try {
      const response = await fetch("/api/material-color-variants", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          materialId: variantForm.materialId,
          colorName: variantForm.colorName.trim(),
          colorCode: variantForm.colorCode.trim() || null,
          stock: Number(variantForm.stock),
          minimumStock: Number(variantForm.minimumStock),
          price: Number(variantForm.price),
          rollQuantity: variantForm.rollQuantity ? Number(variantForm.rollQuantity) : null,
          meterPerRoll: variantForm.meterPerRoll ? Number(variantForm.meterPerRoll) : null,
          purchaseOrderNumber: variantForm.purchaseOrderNumber.trim() || null,
          purchaseDate: variantForm.purchaseDate || null,
          purchaseNotes: variantForm.purchaseNotes.trim() || null,
          supplier: variantForm.supplier.trim() || null,
        }),
      })

      const data = await response.json()

      if (data.success) {
        await fetchVariants()
        setIsAddVariantOpen(false)
        setVariantForm({
          materialId: "",
          colorName: "",
          colorCode: "",
          stock: 0,
          minimumStock: 0,
          price: 0,
          rollQuantity: 0,
          meterPerRoll: 0,
          purchaseOrderNumber: "",
          purchaseDate: "",
          purchaseNotes: "",
          supplier: "",
        })
        toast.success("Varian Ditambahkan", "Varian warna berhasil ditambahkan")
      } else {
        toast.error("Gagal Menambahkan", data.error || "Tidak dapat menambahkan varian")
      }
    } catch (error) {
      console.error("Error adding variant:", error)
      toast.error("Error", "Gagal menambahkan varian")
    } finally {
      setIsSaving(false)
    }
  }

  const handleEditVariant = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!selectedVariant) return

    setIsSaving(true)

    try {
      const response = await fetch(`/api/material-color-variants/${selectedVariant.id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          colorCode: variantForm.colorCode.trim() || null,
          minimumStock: Number(variantForm.minimumStock),
          price: Number(variantForm.price),
          supplier: variantForm.supplier.trim() || null,
        }),
      })

      const data = await response.json()

      if (data.success) {
        await fetchVariants()
        setIsEditVariantOpen(false)
        setSelectedVariant(null)
        toast.success("Varian Diperbarui", "Varian berhasil diperbarui")
      } else {
        toast.error("Gagal Memperbarui", data.error || "Tidak dapat memperbarui varian")
      }
    } catch (error) {
      console.error("Error updating variant:", error)
      toast.error("Error", "Gagal memperbarui varian")
    } finally {
      setIsSaving(false)
    }
  }

  const handleDeleteVariant = async () => {
    if (!selectedVariant) return

    setIsSaving(true)

    try {
      const response = await fetch(`/api/material-color-variants/${selectedVariant.id}`, {
        method: "DELETE",
      })

      const data = await response.json()

      if (data.success) {
        await fetchVariants()
        setIsDeleteDialogOpen(false)
        setSelectedVariant(null)
        toast.success("Varian Dihapus", "Varian berhasil dihapus")
      } else {
        toast.error("Gagal Menghapus", data.error || "Tidak dapat menghapus varian")
      }
    } catch (error) {
      console.error("Error deleting variant:", error)
      toast.error("Error", "Gagal menghapus varian")
    } finally {
      setIsSaving(false)
    }
  }

  const openEditDialog = (variant: MaterialColorVariant) => {
    setSelectedVariant(variant)
    setVariantForm({
      materialId: variant.materialId,
      colorName: variant.colorName,
      colorCode: variant.colorCode || "",
      stock: variant.stock,
      minimumStock: variant.minimumStock,
      price: variant.price,
      rollQuantity: variant.rollQuantity || 0,
      meterPerRoll: variant.meterPerRoll || 0,
      purchaseOrderNumber: variant.purchaseOrderNumber || "",
      purchaseDate: variant.purchaseDate ? new Date(variant.purchaseDate).toISOString().split('T')[0] : "",
      purchaseNotes: variant.purchaseNotes || "",
      supplier: variant.supplier || "",
    })
    setIsEditVariantOpen(true)
  }

  const openDeleteDialog = (variant: MaterialColorVariant) => {
    setSelectedVariant(variant)
    setIsDeleteDialogOpen(true)
  }

  const getStockStatus = (current: number, minimum: number) => {
    if (current === 0) return "critical"
    if (current <= minimum) return "low"
    return "good"
  }

  const filteredVariants = variants.filter((variant) =>
    variant.material.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    variant.material.code.toLowerCase().includes(searchQuery.toLowerCase()) ||
    variant.colorName.toLowerCase().includes(searchQuery.toLowerCase())
  )

  const formatPrice = (price: number) => {
    return new Intl.NumberFormat("id-ID", {
      style: "currency",
      currency: "IDR",
      minimumFractionDigits: 0,
    }).format(price)
  }

  return (
    <div className="flex-1 space-y-4 p-4 sm:p-8 pt-6">
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h2 className="text-3xl font-bold tracking-tight">Inventaris Bahan Baku</h2>
          <p className="text-muted-foreground">
            Pantau tingkat stok bahan baku dan varian warna
          </p>
        </div>
        <div className="flex gap-2 flex-wrap">
          <Dialog open={isCreateMaterialOpen} onOpenChange={setIsCreateMaterialOpen}>
            <DialogTrigger asChild>
              <Button>
                <Plus className="mr-2 h-4 w-4" />
                Tambah Bahan Baku
              </Button>
            </DialogTrigger>
            <DialogContent className="max-w-[95vw] sm:max-w-lg max-h-[90vh] overflow-y-auto">
              <DialogHeader>
                <DialogTitle>Tambah Bahan Baku Baru</DialogTitle>
                <DialogDescription>
                  Tambahkan bahan baku baru ke sistem. Setelah ditambahkan, Anda bisa menambahkan varian warna.
                </DialogDescription>
              </DialogHeader>
              <form onSubmit={handleCreateMaterial} className="space-y-4">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="code">Kode Bahan *</Label>
                    <Input
                      id="code"
                      value={createMaterialForm.code}
                      onChange={(e) =>
                        setCreateMaterialForm({ ...createMaterialForm, code: e.target.value })
                      }
                      placeholder="MAT-KAIN-001"
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="name">Nama Bahan *</Label>
                    <Input
                      id="name"
                      value={createMaterialForm.name}
                      onChange={(e) =>
                        setCreateMaterialForm({ ...createMaterialForm, name: e.target.value })
                      }
                      placeholder="Kain Katun Premium"
                      required
                    />
                  </div>
                </div>
                <div className="space-y-2">
                  <Label htmlFor="description">Deskripsi</Label>
                  <Textarea
                    id="description"
                    value={createMaterialForm.description}
                    onChange={(e) =>
                      setCreateMaterialForm({ ...createMaterialForm, description: e.target.value })
                    }
                    placeholder="Deskripsi bahan..."
                    rows={3}
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="supplier">Supplier</Label>
                  <Input
                    id="supplier"
                    value={createMaterialForm.supplier}
                    onChange={(e) =>
                      setCreateMaterialForm({ ...createMaterialForm, supplier: e.target.value })
                    }
                    placeholder="Nama supplier..."
                  />
                </div>
                <DialogFooter className="flex flex-col-reverse sm:flex-row gap-2">
                  <Button
                    type="button"
                    variant="outline"
                    onClick={() => setIsCreateMaterialOpen(false)}
                    disabled={isSaving}
                  >
                    Batal
                  </Button>
                  <Button type="submit" disabled={isSaving}>
                    {isSaving ? "Menyimpan..." : "Simpan"}
                  </Button>
                </DialogFooter>
              </form>
            </DialogContent>
          </Dialog>

          <Dialog open={isAddVariantOpen} onOpenChange={setIsAddVariantOpen}>
            <DialogTrigger asChild>
              <Button variant="outline">
                <Plus className="mr-2 h-4 w-4" />
                Tambah Varian Warna
              </Button>
            </DialogTrigger>
            <DialogContent className="max-w-[95vw] sm:max-w-2xl max-h-[90vh] overflow-y-auto">
              <DialogHeader>
                <DialogTitle>Tambah Varian Warna</DialogTitle>
                <DialogDescription>
                  Tambahkan varian warna baru untuk bahan baku yang sudah ada
                </DialogDescription>
              </DialogHeader>
              <form onSubmit={handleAddVariant} className="space-y-4">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div className="space-y-2 sm:col-span-2">
                    <Label htmlFor="materialId">Bahan Baku *</Label>
                    <select
                      id="materialId"
                      value={variantForm.materialId}
                      onChange={(e) =>
                        setVariantForm({ ...variantForm, materialId: e.target.value })
                      }
                      className="w-full rounded-md border border-input bg-background px-3 py-2"
                      required
                    >
                      <option value="">Pilih bahan baku...</option>
                      {materials.map((material) => (
                        <option key={material.id} value={material.id}>
                          {material.code} - {material.name}
                        </option>
                      ))}
                    </select>
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="colorName">Nama Warna *</Label>
                    <Input
                      id="colorName"
                      value={variantForm.colorName}
                      onChange={(e) =>
                        setVariantForm({ ...variantForm, colorName: e.target.value })
                      }
                      placeholder="Merah"
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="colorCode">Kode Warna</Label>
                    <Input
                      id="colorCode"
                      value={variantForm.colorCode}
                      onChange={(e) =>
                        setVariantForm({ ...variantForm, colorCode: e.target.value })
                      }
                      placeholder="#FF0000"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="stock">Stok Awal (Meter) *</Label>
                    <Input
                      id="stock"
                      type="number"
                      step="0.01"
                      value={variantForm.stock}
                      onChange={(e) =>
                        setVariantForm({ ...variantForm, stock: Number(e.target.value) })
                      }
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="minimumStock">Minimum Stok (Meter) *</Label>
                    <Input
                      id="minimumStock"
                      type="number"
                      step="0.01"
                      value={variantForm.minimumStock}
                      onChange={(e) =>
                        setVariantForm({ ...variantForm, minimumStock: Number(e.target.value) })
                      }
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="price">Harga per Meter *</Label>
                    <Input
                      id="price"
                      type="number"
                      step="0.01"
                      value={variantForm.price}
                      onChange={(e) =>
                        setVariantForm({ ...variantForm, price: Number(e.target.value) })
                      }
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="rollQuantity">Jumlah Roll</Label>
                    <Input
                      id="rollQuantity"
                      type="number"
                      value={variantForm.rollQuantity}
                      onChange={(e) =>
                        setVariantForm({ ...variantForm, rollQuantity: Number(e.target.value) })
                      }
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="meterPerRoll">Meter per Roll</Label>
                    <Input
                      id="meterPerRoll"
                      type="number"
                      step="0.01"
                      value={variantForm.meterPerRoll}
                      onChange={(e) =>
                        setVariantForm({ ...variantForm, meterPerRoll: Number(e.target.value) })
                      }
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="supplier">Supplier</Label>
                    <Input
                      id="supplier"
                      value={variantForm.supplier}
                      onChange={(e) =>
                        setVariantForm({ ...variantForm, supplier: e.target.value })
                      }
                      placeholder="Nama supplier..."
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="purchaseOrderNumber">No. PO</Label>
                    <Input
                      id="purchaseOrderNumber"
                      value={variantForm.purchaseOrderNumber}
                      onChange={(e) =>
                        setVariantForm({ ...variantForm, purchaseOrderNumber: e.target.value })
                      }
                      placeholder="PO-001"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="purchaseDate">Tanggal Pembelian</Label>
                    <Input
                      id="purchaseDate"
                      type="date"
                      value={variantForm.purchaseDate}
                      onChange={(e) =>
                        setVariantForm({ ...variantForm, purchaseDate: e.target.value })
                      }
                    />
                  </div>
                  <div className="space-y-2 sm:col-span-2">
                    <Label htmlFor="purchaseNotes">Catatan Pembelian</Label>
                    <Textarea
                      id="purchaseNotes"
                      value={variantForm.purchaseNotes}
                      onChange={(e) =>
                        setVariantForm({ ...variantForm, purchaseNotes: e.target.value })
                      }
                      placeholder="Catatan..."
                      rows={2}
                    />
                  </div>
                </div>
                <DialogFooter className="flex flex-col-reverse sm:flex-row gap-2">
                  <Button
                    type="button"
                    variant="outline"
                    onClick={() => setIsAddVariantOpen(false)}
                    disabled={isSaving}
                  >
                    Batal
                  </Button>
                  <Button type="submit" disabled={isSaving}>
                    {isSaving ? "Menyimpan..." : "Simpan"}
                  </Button>
                </DialogFooter>
              </form>
            </DialogContent>
          </Dialog>
        </div>
      </div>

      {/* Statistics Cards */}
      <div className="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Total Varian</CardTitle>
            <Package2 className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{statistics.totalVariants}</div>
            <p className="text-xs text-muted-foreground">varian warna aktif</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Stok Rendah</CardTitle>
            <TrendingDown className="h-4 w-4 text-orange-500" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-orange-600">
              {statistics.lowStockItems}
            </div>
            <p className="text-xs text-muted-foreground">item perlu diisi ulang</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Stok Habis</CardTitle>
            <TrendingDown className="h-4 w-4 text-red-500" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-red-600">
              {statistics.outOfStockItems}
            </div>
            <p className="text-xs text-muted-foreground">item habis</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Total Nilai</CardTitle>
            <TrendingUp className="h-4 w-4 text-green-500" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{formatPrice(statistics.totalValue)}</div>
            <p className="text-xs text-muted-foreground">nilai inventaris</p>
          </CardContent>
        </Card>
      </div>

      {/* Materials Table */}
      <Card>
        <CardHeader>
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <CardTitle>Daftar Bahan Baku & Varian</CardTitle>
            <div className="relative w-full sm:w-64">
              <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
              <Input
                placeholder="Cari bahan atau warna..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="pl-8"
              />
            </div>
          </div>
        </CardHeader>
        <CardContent>
          <div className="rounded-md border overflow-x-auto">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Kode</TableHead>
                  <TableHead>Nama Bahan</TableHead>
                  <TableHead>Warna</TableHead>
                  <TableHead className="text-right">Stok</TableHead>
                  <TableHead className="text-right">Min. Stok</TableHead>
                  <TableHead className="text-right">Harga/Meter</TableHead>
                  <TableHead>Status</TableHead>
                  <TableHead className="text-right">Aksi</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {isLoading ? (
                  <TableRow>
                    <TableCell colSpan={8} className="text-center">
                      Loading...
                    </TableCell>
                  </TableRow>
                ) : filteredVariants.length === 0 ? (
                  <TableRow>
                    <TableCell colSpan={8} className="text-center">
                      Tidak ada data
                    </TableCell>
                  </TableRow>
                ) : (
                  filteredVariants.map((variant) => {
                    const status = getStockStatus(variant.stock, variant.minimumStock)
                    return (
                      <TableRow key={variant.id}>
                        <TableCell className="font-medium">{variant.material.code}</TableCell>
                        <TableCell>{variant.material.name}</TableCell>
                        <TableCell>
                          <div className="flex items-center gap-2">
                            {variant.colorCode && (
                              <div
                                className="w-4 h-4 rounded border"
                                style={{ backgroundColor: variant.colorCode }}
                              />
                            )}
                            {variant.colorName}
                          </div>
                        </TableCell>
                        <TableCell className="text-right">
                          {variant.stock.toFixed(2)} {variant.material.unit}
                        </TableCell>
                        <TableCell className="text-right">
                          {variant.minimumStock.toFixed(2)} {variant.material.unit}
                        </TableCell>
                        <TableCell className="text-right">{formatPrice(variant.price)}</TableCell>
                        <TableCell>
                          {status === "critical" && (
                            <Badge variant="destructive">Habis</Badge>
                          )}
                          {status === "low" && (
                            <Badge className="bg-orange-100 text-orange-800">Rendah</Badge>
                          )}
                          {status === "good" && (
                            <Badge className="bg-green-100 text-green-800">Aman</Badge>
                          )}
                        </TableCell>
                        <TableCell>
                          <div className="flex justify-end gap-2">
                            <Button
                              variant="ghost"
                              size="sm"
                              onClick={() => openEditDialog(variant)}
                            >
                              <Edit className="h-4 w-4" />
                            </Button>
                            <Button
                              variant="ghost"
                              size="sm"
                              onClick={() => openDeleteDialog(variant)}
                            >
                              <Trash2 className="h-4 w-4 text-red-500" />
                            </Button>
                          </div>
                        </TableCell>
                      </TableRow>
                    )
                  })
                )}
              </TableBody>
            </Table>
          </div>
        </CardContent>
      </Card>

      {/* Edit Variant Dialog */}
      <Dialog open={isEditVariantOpen} onOpenChange={setIsEditVariantOpen}>
        <DialogContent className="max-w-[95vw] sm:max-w-lg max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Edit Varian</DialogTitle>
            <DialogDescription>
              Edit informasi varian {selectedVariant?.material.name} - {selectedVariant?.colorName}
            </DialogDescription>
          </DialogHeader>
          <form onSubmit={handleEditVariant} className="space-y-4">
            <div className="grid grid-cols-1 gap-4">
              <div className="space-y-2">
                <Label htmlFor="edit-colorCode">Kode Warna</Label>
                <Input
                  id="edit-colorCode"
                  value={variantForm.colorCode}
                  onChange={(e) =>
                    setVariantForm({ ...variantForm, colorCode: e.target.value })
                  }
                  placeholder="#FF0000"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="edit-minimumStock">Minimum Stok (Meter)</Label>
                <Input
                  id="edit-minimumStock"
                  type="number"
                  step="0.01"
                  value={variantForm.minimumStock}
                  onChange={(e) =>
                    setVariantForm({ ...variantForm, minimumStock: Number(e.target.value) })
                  }
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="edit-price">Harga per Meter</Label>
                <Input
                  id="edit-price"
                  type="number"
                  step="0.01"
                  value={variantForm.price}
                  onChange={(e) =>
                    setVariantForm({ ...variantForm, price: Number(e.target.value) })
                  }
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="edit-supplier">Supplier</Label>
                <Input
                  id="edit-supplier"
                  value={variantForm.supplier}
                  onChange={(e) =>
                    setVariantForm({ ...variantForm, supplier: e.target.value })
                  }
                />
              </div>
            </div>
            <DialogFooter className="flex flex-col-reverse sm:flex-row gap-2">
              <Button
                type="button"
                variant="outline"
                onClick={() => setIsEditVariantOpen(false)}
                disabled={isSaving}
              >
                Batal
              </Button>
              <Button type="submit" disabled={isSaving}>
                {isSaving ? "Menyimpan..." : "Simpan Perubahan"}
              </Button>
            </DialogFooter>
          </form>
        </DialogContent>
      </Dialog>

      {/* Delete Confirmation Dialog */}
      <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Hapus Varian?</AlertDialogTitle>
            <AlertDialogDescription>
              Apakah Anda yakin ingin menghapus varian{" "}
              <strong>
                {selectedVariant?.material.name} - {selectedVariant?.colorName}
              </strong>
              ? Tindakan ini tidak dapat dibatalkan.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={isSaving}>Batal</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDeleteVariant}
              disabled={isSaving}
              className="bg-red-600 hover:bg-red-700"
            >
              {isSaving ? "Menghapus..." : "Hapus"}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  )
}
