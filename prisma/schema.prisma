// This is your Prisma schema file for TrackPro App
// Optimized for production garment manufacturing workflow

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// AUTHENTICATION & AUTHORIZATION
// ============================================

enum UserRole {
  OWNER
  KEPALA_GUDANG
  KEPALA_PRODUKSI
  PEMOTONG
  PENJAHIT
  FINISHING
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String   @unique
  password  String // Hashed with bcrypt
  name      String
  role      UserRole
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  createdProducts         Product[]             @relation("ProductCreator")
  createdMaterials        Material[]            @relation("MaterialCreator")
  createdBatches          ProductionBatch[]     @relation("BatchCreator")
  materialTransactions    MaterialTransaction[]
  cuttingTasks            CuttingTask[]         @relation("CuttingTaskAssigned")
  sewingTasks             SewingTask[]          @relation("SewingTaskAssigned")
  finishingTasks          FinishingTask[]       @relation("FinishingTaskAssigned")
  verifiedCuttingTasks    CuttingTask[]         @relation("CuttingTaskVerified")
  verifiedSewingTasks     SewingTask[]          @relation("SewingTaskVerified")
  verifiedFinishingTasks  FinishingTask[]       @relation("FinishingTaskVerified")
  confirmedCuttingResults CuttingResult[]       @relation("CuttingResultConfirmed")
  confirmedSewingResults  SewingResult[]        @relation("SewingResultConfirmed")
  verifiedFinishedGoods   FinishedGood[]
  notifications           Notification[]
  auditLogs               AuditLog[]

  // Sub-batch relations (warehouse verification only)
  verifiedSubBatchesWarehouse SubBatch[] @relation("SubBatchWarehouseVerifier")

  @@index([email])
  @@index([username])
  @@index([role])
  @@map("users")
}

// ============================================
// PRODUCT MANAGEMENT
// ============================================

enum ProductStatus {
  ACTIVE
  INACTIVE
  DISCONTINUED
}

model Product {
  id          String        @id @default(cuid())
  sku         String        @unique // SKU Produk
  name        String
  description String?
  price       Decimal       @db.Decimal(15, 2)
  status      ProductStatus @default(ACTIVE)
  images      String[] // Array of image URLs
  isDeleted   Boolean       @default(false) // Soft delete
  createdById String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  createdBy         User                  @relation("ProductCreator", fields: [createdById], references: [id])
  productionBatches ProductionBatch[]
  materials         ProductMaterial[]
  colorVariants     ProductColorVariant[] // Varian warna produk
  sizeVariants      ProductSizeVariant[]  // Varian ukuran produk

  @@index([sku])
  @@index([status])
  @@index([createdById])
  @@map("products")
}

// Product Color Variants (Varian Warna Produk)
model ProductColorVariant {
  id        String   @id @default(cuid())
  productId String
  colorName String // Nama warna produk (Putih, Hitam, Merah, dll)
  colorCode String? // Kode warna (hex color atau custom code)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, colorName])
  @@index([productId])
  @@index([colorName])
  @@map("product_color_variants")
}

// Product Size Variants (Varian Ukuran Produk)
model ProductSizeVariant {
  id        String   @id @default(cuid())
  productId String
  sizeName  String // Nama ukuran (XS, S, M, L, XL, XXL, XXXL, dll atau custom)
  sizeOrder Int      @default(0) // Urutan tampilan ukuran
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, sizeName])
  @@index([productId])
  @@index([sizeName])
  @@map("product_size_variants")
}

// ============================================
// MATERIAL (BAHAN BAKU) MANAGEMENT
// ============================================

enum MaterialUnit {
  METER
  YARD
  KILOGRAM
  GRAM
  PIECE
  ROLL
  BOX
}

model Material {
  id           String       @id @default(cuid())
  code         String       @unique
  name         String
  description  String?
  color        String? // Warna bahan baku (misal: Putih, Hitam, Merah, dll)
  unit         MaterialUnit @default(METER) // Unit utama dalam METER
  rollQuantity Decimal?     @db.Decimal(15, 3) // Jumlah roll (informasi tambahan)

  // Informasi Pembelian
  purchaseOrderNumber String? // Kode nota pemesanan
  supplier            String? // Nama supplier
  purchaseDate        DateTime? // Tanggal pembelian
  purchaseNotes       String? // Catatan pembelian

  isActive    Boolean  @default(true)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  createdBy        User                      @relation("MaterialCreator", fields: [createdById], references: [id])
  transactions     MaterialTransaction[]
  products         ProductMaterial[]
  batchAllocations BatchMaterialAllocation[]
  colorVariants    MaterialColorVariant[] // Varian warna material

  @@index([code])
  @@index([purchaseOrderNumber])
  @@index([color])
  @@map("materials")
}

// Variant Unit for MaterialColorVariant
enum VariantUnit {
  YARD
  KILOGRAM
}

// Material Color Variants (Varian Warna Material)
model MaterialColorVariant {
  id           String      @id @default(cuid())
  materialId   String
  colorName    String // Nama warna (Putih, Hitam, Merah, dll)
  colorCode    String? // Kode bahan pabrik (factory material code)
  stock        Decimal     @db.Decimal(15, 3) // Stock untuk warna ini
  minimumStock Decimal     @default(0) @db.Decimal(15, 3) // Minimum stock
  unit         VariantUnit @default(YARD) // Satuan: YARD atau KILOGRAM

  // Pricing & Purchase Info
  price               Decimal   @default(0) @db.Decimal(15, 2) // Harga per unit
  rollQuantity        Decimal?  @db.Decimal(15, 3) // Jumlah roll
  meterPerRoll        Decimal?  @db.Decimal(15, 3) // Unit per roll
  purchaseOrderNumber String? // Kode nota pemesanan
  purchaseDate        DateTime? // Tanggal pembelian
  purchaseNotes       String? // Catatan pembelian
  supplier            String? // Nama supplier

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  material         Material                       @relation(fields: [materialId], references: [id], onDelete: Cascade)
  batchAllocations BatchMaterialColorAllocation[] // Alokasi untuk batch

  @@unique([materialId, colorName])
  @@index([materialId])
  @@index([colorName])
  @@map("material_color_variants")
}

// Product Materials (Many-to-Many with quantity)
model ProductMaterial {
  id         String       @id @default(cuid())
  productId  String
  materialId String
  quantity   Decimal      @db.Decimal(15, 3)
  unit       MaterialUnit
  color      String?

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([productId, materialId])
  @@map("product_materials")
}

// ============================================
// MATERIAL TRANSACTIONS (STOCK IN/OUT)
// ============================================

enum TransactionType {
  IN // Stock masuk
  OUT // Stock keluar untuk produksi
  ADJUSTMENT
  RETURN
}

model MaterialTransaction {
  id         String          @id @default(cuid())
  materialId String
  type       TransactionType
  quantity   Decimal         @db.Decimal(15, 3)
  unit       MaterialUnit
  notes      String?
  batchId    String? // Reference to production batch if OUT

  // Purchase Information (for type IN)
  rollQuantity        Decimal?  @db.Decimal(15, 3)
  meterPerRoll        Decimal?  @db.Decimal(15, 3)
  purchaseOrderNumber String?
  supplier            String?
  purchaseDate        DateTime?
  purchaseNotes       String?

  userId    String
  createdAt DateTime @default(now())

  material Material         @relation(fields: [materialId], references: [id])
  user     User             @relation(fields: [userId], references: [id])
  batch    ProductionBatch? @relation(fields: [batchId], references: [id])

  @@index([materialId])
  @@index([type])
  @@index([createdAt])
  @@index([batchId])
  @@index([purchaseOrderNumber])
  @@map("material_transactions")
}

// ============================================
// PRODUCTION BATCH MANAGEMENT
// ============================================

enum BatchStatus {
  PENDING // Batch created, waiting for material allocation
  MATERIAL_REQUESTED // Material request sent to warehouse
  MATERIAL_ALLOCATED // Material allocated by warehouse
  ASSIGNED_TO_CUTTER // Assigned to cutting department (Ka. Pemotong)
  IN_CUTTING // Currently being cut
  CUTTING_COMPLETED // Cutting done, waiting for verification
  CUTTING_VERIFIED // Verified by production head, ready for sewing
  ASSIGNED_TO_SEWER // Assigned to sewing department (Ka. Penjahit)
  IN_SEWING // Currently being sewn
  SEWING_COMPLETED // Sewing done, waiting for verification
  SEWING_VERIFIED // Verified by production head, ready for finishing
  ASSIGNED_TO_FINISHING // Assigned to finishing department (Ka. Finishing)
  IN_FINISHING // Currently in finishing (iterative with partial sub-batches)
  FINISHING_COMPLETED // All finishing done, all goods sent to warehouse
  WAREHOUSE_VERIFIED // All goods verified by warehouse head
  COMPLETED // All processes completed
  CANCELLED // Batch cancelled
}

model ProductionBatch {
  id             String      @id @default(cuid())
  batchSku       String      @unique // Format: PROD-YYYYMMDD-XXX
  productId      String
  totalRolls     Int         @default(0) // Total roll bahan baku yang dibawa
  actualQuantity Int         @default(0) // Total pieces setelah dipotong
  rejectQuantity Int         @default(0)
  status         BatchStatus @default(PENDING)
  startDate      DateTime    @default(now())
  completedDate  DateTime?
  notes          String?
  createdById    String
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Relations
  product                  Product                        @relation(fields: [productId], references: [id])
  createdBy                User                           @relation("BatchCreator", fields: [createdById], references: [id])
  materialAllocations      BatchMaterialAllocation[]
  materialColorAllocations BatchMaterialColorAllocation[] // Alokasi varian warna
  materialTransactions     MaterialTransaction[]
  sizeColorRequests        BatchSizeColorRequest[] // Request ukuran dan warna
  cuttingResults           CuttingResult[] // Hasil pemotongan aktual
  sewingResults            SewingResult[]
  cuttingTask              CuttingTask?
  sewingTask               SewingTask? // Legacy - untuk backward compatibility
  finishingTask            FinishingTask? // Legacy - untuk backward compatibility
  subBatches               SubBatch[] // Sub-batches untuk sewing & finishing
  qualityChecks            QualityCheck[]
  timeline                 BatchTimeline[]
  finishedGoods            FinishedGood[]

  @@index([batchSku])
  @@index([status])
  @@index([productId])
  @@index([createdAt])
  @@map("production_batches")
}

// ============================================
// MATERIAL ALLOCATION FOR BATCHES
// ============================================

enum AllocationStatus {
  REQUESTED
  APPROVED
  REJECTED
  ALLOCATED
}

model BatchMaterialAllocation {
  id           String           @id @default(cuid())
  batchId      String
  materialId   String
  color        String // Warna material yang diminta
  rollQuantity Int // Jumlah roll yang dibawa
  requestedQty Decimal          @db.Decimal(15, 3) // Total meter (rollQuantity * meterPerRoll)
  allocatedQty Decimal?         @db.Decimal(15, 3)
  status       AllocationStatus @default(REQUESTED)
  notes        String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  batch    ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  material Material        @relation(fields: [materialId], references: [id])

  @@index([batchId])
  @@index([status])
  @@map("batch_material_allocations")
}

// Allocation per Material Color Variant (Tracking varian warna untuk setiap batch)
model BatchMaterialColorAllocation {
  id                       String   @id @default(cuid())
  batchId                  String
  materialColorVariantId   String
  rollQuantity             Int // Jumlah roll untuk warna ini
  allocatedQty             Decimal  @db.Decimal(15, 3) // Total meter yang dialokasikan
  meterPerRoll             Decimal  @default(95) @db.Decimal(15, 3) // Panjang per roll (default 95m)
  stockAtAllocation        Decimal? @db.Decimal(15, 3) // Stok varian saat alokasi (untuk tracking penggunaan)
  rollQuantityAtAllocation Decimal? @db.Decimal(15, 3) // Jumlah roll varian saat alokasi
  notes                    String?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  batch                ProductionBatch      @relation(fields: [batchId], references: [id], onDelete: Cascade)
  materialColorVariant MaterialColorVariant @relation(fields: [materialColorVariantId], references: [id])

  @@index([batchId])
  @@index([materialColorVariantId])
  @@map("batch_material_color_allocations")
}

// ============================================
// PRODUCTION TASKS
// ============================================

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  VERIFIED
  REJECTED
}

// Cutting Task (Tracking hasil pemotongan - no reject at this stage)
model CuttingTask {
  id               String     @id @default(cuid())
  batchId          String     @unique
  assignedToId     String // Ka. Pemotong yang bertanggung jawab
  materialReceived Decimal    @db.Decimal(15, 3)
  piecesCompleted  Int        @default(0)
  wasteQty         Decimal?   @db.Decimal(15, 3) // Sisa bahan (bukan reject)
  status           TaskStatus @default(PENDING)
  notes            String?
  startedAt        DateTime?
  completedAt      DateTime?
  verifiedAt       DateTime?
  verifiedById     String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  batch      ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  assignedTo User            @relation("CuttingTaskAssigned", fields: [assignedToId], references: [id])
  verifiedBy User?           @relation("CuttingTaskVerified", fields: [verifiedById], references: [id])

  @@index([status])
  @@index([assignedToId])
  @@map("cutting_tasks")
}

// Sewing Task (Tracking hasil jahitan - no reject at this stage)
model SewingTask {
  id              String     @id @default(cuid())
  batchId         String     @unique
  assignedToId    String // Ka. Penjahit yang bertanggung jawab
  piecesReceived  Int // Pieces dari cutting
  piecesCompleted Int        @default(0) // Hasil jahitan
  status          TaskStatus @default(PENDING)
  notes           String?
  startedAt       DateTime?
  completedAt     DateTime?
  verifiedAt      DateTime?
  verifiedById    String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  batch      ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  assignedTo User            @relation("SewingTaskAssigned", fields: [assignedToId], references: [id])
  verifiedBy User?           @relation("SewingTaskVerified", fields: [verifiedById], references: [id])

  @@index([status])
  @@index([assignedToId])
  @@map("sewing_tasks")
}

// Finishing Task (Tracking keseluruhan finishing - reject dicatat di sini)
model FinishingTask {
  id              String     @id @default(cuid())
  batchId         String     @unique
  assignedToId    String // Ka. Finishing yang bertanggung jawab
  piecesReceived  Int // Pieces dari sewing
  piecesCompleted Int        @default(0) // Total hasil finishing (good + reject)
  
  // Reject tracking - baru dicatat di tahap finishing
  rejectKotor      Int        @default(0) // Kotor - di-reproduksi dengan dicuci
  rejectSobek      Int        @default(0) // Sobek - masuk Bad Stock
  rejectRusakJahit Int        @default(0) // Rusak jahit - masuk Bad Stock
  
  status          TaskStatus @default(PENDING)
  notes           String?
  startedAt       DateTime?
  completedAt     DateTime?
  verifiedAt      DateTime?
  verifiedById    String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  batch      ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  assignedTo User            @relation("FinishingTaskAssigned", fields: [assignedToId], references: [id])
  verifiedBy User?           @relation("FinishingTaskVerified", fields: [verifiedById], references: [id])

  @@index([status])
  @@index([assignedToId])
  @@map("finishing_tasks")
}

// ============================================
// SUB-BATCH (Pemecahan hasil finishing untuk tracking ke gudang)
// Sub-batch dibuat di tahap FINISHING untuk tracking partial delivery ke warehouse
// ============================================

enum SubBatchStatus {
  CREATED // Sub-batch dibuat dari hasil finishing
  SUBMITTED_TO_WAREHOUSE // Diserahkan ke gudang
  WAREHOUSE_VERIFIED // Diverifikasi gudang
  COMPLETED // Selesai
}

// Jenis reject/defect di finishing
enum FinishingDefectType {
  KOTOR // Kotor - akan di-reproduksi dengan dicuci di gudang
  SOBEK // Sobek - masuk Bad Stock (BS)
  RUSAK_JAHIT // Rusak jahit - masuk Bad Stock (BS)
}

model SubBatch {
  id          String @id @default(cuid())
  subBatchSku String @unique // Format: BATCH-SKU-SUB-001
  batchId     String

  // Warehouse verification (diisi saat verifikasi gudang)
  warehouseVerifiedById String?

  // Quantity tracking - output dari finishing yang siap ke gudang
  finishingGoodOutput Int @default(0) // Hasil finishing barang jadi (good pieces)
  
  // Reject tracking - reject baru dicatat di tahap finishing
  rejectKotor     Int @default(0) // Kotor - di-reproduksi dengan dicuci
  rejectSobek     Int @default(0) // Sobek - masuk Bad Stock
  rejectRusakJahit Int @default(0) // Rusak jahit - masuk Bad Stock

  status SubBatchStatus @default(CREATED)
  notes  String?

  // Timestamps
  createdAt              DateTime  @default(now())
  verifiedByProdAt       DateTime? // Diverifikasi Ka. Prod sebelum ke gudang
  submittedToWarehouseAt DateTime?
  warehouseVerifiedAt    DateTime?

  updatedAt DateTime @updatedAt

  // Relations
  batch               ProductionBatch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  warehouseVerifiedBy User?              @relation("SubBatchWarehouseVerifier", fields: [warehouseVerifiedById], references: [id])
  items               SubBatchItem[] // Detail per size/color
  timeline            SubBatchTimeline[]
  finishedGoods       FinishedGood[] // Barang jadi yang dihasilkan

  @@index([batchId])
  @@index([status])
  @@map("sub_batches")
}

// Detail item per size/color dalam sub-batch (hasil finishing)
model SubBatchItem {
  id          String @id @default(cuid())
  subBatchId  String
  productSize String // Ukuran (S, M, L, XL, XXL)
  color       String // Warna
  
  // Hasil finishing per item
  goodQuantity      Int @default(0) // Barang jadi bagus
  rejectKotor       Int @default(0) // Kotor - dicuci di gudang
  rejectSobek       Int @default(0) // Sobek - Bad Stock
  rejectRusakJahit  Int @default(0) // Rusak jahit - Bad Stock
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subBatch SubBatch @relation(fields: [subBatchId], references: [id], onDelete: Cascade)

  @@index([subBatchId])
  @@map("sub_batch_items")
}

// Timeline untuk sub-batch
model SubBatchTimeline {
  id         String   @id @default(cuid())
  subBatchId String
  event      String // Event description
  details    String?
  createdAt  DateTime @default(now())

  subBatch SubBatch @relation(fields: [subBatchId], references: [id], onDelete: Cascade)

  @@index([subBatchId])
  @@index([createdAt])
  @@map("sub_batch_timeline")
}

// ============================================
// SIZE & COLOR REQUESTS (Request Ukuran & Warna)
// ============================================

model BatchSizeColorRequest {
  id              String   @id @default(cuid())
  batchId         String
  productSize     String // Ukuran produk (S, M, L, XL, XXL, dll)
  color           String // Warna yang diminta
  requestedPieces Int // Jumlah potongan yang diminta
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  batch ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@map("batch_size_color_requests")
}

// ============================================
// CUTTING RESULTS (Hasil Pemotongan Aktual)
// ============================================

model CuttingResult {
  id            String    @id @default(cuid())
  batchId       String
  productSize   String // Ukuran produk (S, M, L, XL, XXL, dll)
  color         String // Warna hasil potongan
  actualPieces  Int // Jumlah potongan yang terealisasi
  isConfirmed   Boolean   @default(false) // Dikonfirmasi oleh kepala produksi
  confirmedById String? // ID user yang konfirmasi (Kepala Produksi atau Pemotong)
  confirmedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  batch       ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  confirmedBy User?           @relation("CuttingResultConfirmed", fields: [confirmedById], references: [id])

  @@index([batchId])
  @@index([isConfirmed])
  @@map("cutting_results")
}

// ============================================
// SEWING RESULTS (Hasil Jahitan Aktual)
// ============================================

model SewingResult {
  id            String    @id @default(cuid())
  batchId       String
  productSize   String // Ukuran produk (S, M, L, XL, XXL, dll)
  color         String // Warna hasil jahitan
  actualPieces  Int // Jumlah potongan yang terealisasi
  isConfirmed   Boolean   @default(false) // Dikonfirmasi oleh kepala produksi
  confirmedById String? // ID user yang konfirmasi (Kepala Produksi atau Penjahit)
  confirmedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  batch       ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  confirmedBy User?           @relation("SewingResultConfirmed", fields: [confirmedById], references: [id])

  @@index([batchId])
  @@index([isConfirmed])
  @@map("sewing_results")
}

// ============================================
// FINISHED GOODS (BARANG JADI)
// ============================================

enum GoodType {
  FINISHED // Barang jadi (produk berhasil)
  REJECT // Barang gagal/reject
}

model FinishedGood {
  id           String   @id @default(cuid())
  batchId      String
  productId    String
  subBatchId   String? // Optional - linked to sub-batch for new flow
  type         GoodType
  quantity     Int
  location     String? // Lokasi penyimpanan di gudang
  notes        String?
  verifiedById String // Kepala gudang yang verifikasi
  verifiedAt   DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  batch      ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  subBatch   SubBatch?       @relation(fields: [subBatchId], references: [id])
  verifiedBy User            @relation(fields: [verifiedById], references: [id])

  @@index([batchId])
  @@index([productId])
  @@index([subBatchId])
  @@index([type])
  @@index([verifiedAt])
  @@map("finished_goods")
}

// ============================================
// QUALITY CONTROL
// ============================================

enum QualityCheckStage {
  CUTTING
  SEWING
  FINISHING
  FINAL
}

enum QualityStatus {
  PASSED
  FAILED
  NEED_REWORK
}

model QualityCheck {
  id        String            @id @default(cuid())
  batchId   String
  stage     QualityCheckStage
  status    QualityStatus
  passedQty Int
  failedQty Int
  reworkQty Int               @default(0)
  remarks   String?
  checkedAt DateTime          @default(now())

  batch ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@index([stage])
  @@map("quality_checks")
}

// ============================================
// BATCH TIMELINE & TRACKING
// ============================================

enum TimelineEvent {
  BATCH_CREATED
  MATERIAL_REQUESTED
  MATERIAL_ALLOCATED
  // Cutting events
  ASSIGNED_TO_CUTTER
  CUTTING_STARTED
  CUTTING_COMPLETED
  CUTTING_VERIFIED
  // Sewing events
  ASSIGNED_TO_SEWER
  SEWING_STARTED
  SEWING_COMPLETED
  SEWING_VERIFIED
  // Finishing events
  ASSIGNED_TO_FINISHING
  FINISHING_STARTED
  FINISHING_COMPLETED
  // Sub-batch events (untuk partial delivery ke warehouse)
  SUB_BATCH_CREATED
  SUB_BATCH_SUBMITTED_TO_WAREHOUSE
  SUB_BATCH_WAREHOUSE_VERIFIED
  // Warehouse & completion events
  WAREHOUSE_VERIFIED
  BATCH_COMPLETED
  BATCH_CANCELLED
}

model BatchTimeline {
  id        String        @id @default(cuid())
  batchId   String
  event     TimelineEvent
  details   String?
  createdAt DateTime      @default(now())

  batch ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@index([createdAt])
  @@map("batch_timeline")
}

// ============================================
// NOTIFICATIONS
// ============================================

enum NotificationType {
  LOW_STOCK
  BATCH_ASSIGNMENT
  VERIFICATION_NEEDED
  DEADLINE_APPROACHING
  TASK_COMPLETED
  MATERIAL_REQUEST
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================
// AUDIT LOG
// ============================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  APPROVE
  REJECT
}

model AuditLog {
  id        String      @id @default(cuid())
  userId    String
  action    AuditAction
  entity    String // Table name
  entityId  String? // Record ID
  oldValues Json?
  newValues Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime    @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}
